{{>header-bottom}}
    <!-- Hero Section End -->

    <!-- Breadcrumb Section Begin -->
    <!-- Breadcrumb Section End -->

    <!-- Product Details Section Begin -->
<section class="product-details spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <div class="product__details__pic">
                        <div class="product__details__pic__item" style="position: relative;">
                            <img class="product__details__pic__item--large"
                                src="https://the-1-beauty-fashion-admin.herokuapp.com{{product.imagesUrl.[0]}}" alt="" >
                                <div class="discount">-{{discount product.pricePromotion product.price}}%</div>
                                <div class="productId" style="display:none;">{{product._id}}</div>
                        </div>
                        <div class="product__details__pic__slider owl-carousel">
                            {{#each product.imagesUrl}}
                            <img data-imgbigurl="https://the-1-beauty-fashion-admin.herokuapp.com{{this}}"
                                src="https://the-1-beauty-fashion-admin.herokuapp.com{{this}}" alt="">
                            {{/each}}
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6">
                    <div class="product__details__text">
                        <h3>{{product.name}}</h3>
                        <div class="product__details__rating">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star-half-o"></i>
                            <span>(18 reviews)</span>
                        </div>
                        <div class="product__details__price">${{product.pricePromotion}} <span class="promotion">${{product.price}}</span></div>
                        <div class="info-product-size-header">Size {{product.info.[0].size}} : {{product.info.[0].quantity}} sản phẩm sẵn có</div>
                        <div class="info-product-size">
                            
                        </div>
                        <p style="margin-top: 30px;">{{{newLine product.des}}}</p>
                        <div class="product__details__quantity">
                            <div class="quantity">
                                <div class="pro-qty">
                                    <input type="text" value="1" name="quantity-product">
                                </div>
                            </div>
                        </div>
                        <span  class="primary-btn btn-add-cart" style="cursor: pointer;" data-id={{product._id}} data-image="https://the-1-beauty-fashion-admin.herokuapp.com{{product.imagesUrl.[0]}}">ADD TO CARD</span>
                        <ul>
                            <li><b>Availability</b> <span> <strong>{{quantityy product.info}} </strong> item in Warehouse</span></li>
                            <li><b>Shipping</b> <span>01 day shipping. <samp>Free pickup today</samp></span></li>
                            <li><b>Share on</b>
                                <div class="share">
                                    <a href="/"><i class="fa fa-facebook"></i></a>
                                    <a href="/"><i class="fa fa-twitter"></i></a>
                                    <a href="/"><i class="fa fa-instagram"></i></a>
                                    <a href="/"><i class="fa fa-pinterest"></i></a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="product__details__tab">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#tabs-1" role="tab"
                                    aria-selected="false">Reviews <span></span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tabs-2" role="tab"
                                    aria-selected="false">Information</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="tabs-1" role="tabpanel">
                                <div class="product__details__tab__desc">

                                    <div class="comment" >
                                        <table>
                                            <tbody class="addCommentEl">
                                            {{#each comment}}
                                            <tr>
                                                <td style="padding:20px;">
                                                {{#if user}}
                                                <img class="avatar-img userNameAvatar abc" src="{{user.avatarUrl}}" alt="" style="width:50px; height:auto;">
                                                {{else}}
                                                <img class="avatar-img userNameAvatar" src="/img/none-user.jpg" alt="" style="width:50px; height:auto;">
                                                {{/if}}
                                                </td>
                                                <td>
                                                    <div style="display:inline-block; margin-top:10px;"> 
                                                        {{#if user}}
                                                        <div class ="userComment" style="font-size:20px;font-weight:600;float:left;">{{user.username}}
                                                        </div> 
                                                        {{else}}
                                                        <div class ="userComment" style="font-size:20px;font-weight:600;float:left;">{{username}}
                                                        </div>
                                                        {{/if}}
                                                        <div style="float:right; margin-top:3px; padding-left:7px; color:rgb(126, 122, 122);">{{timeCalendar createAt}} </div>
                                                        </div>
                                                    <p class="content" style="font-size: 17px; color:#000;">{{content}}</p>
                                                </td>
                                            </tr>
                                            {{else}}
                                            <div style="margin-left: 30px;" class="no-comments"><i class="bi bi-pencil-fill"></i>No comments yet</div>
                                            {{/each}}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div>
                                        <table>
                                            <tr>
                                                <td style="padding:20px;">
                                                <img class="avatar-img commentAvatar" src="" alt="" style="width:50px; height:auto;">
                                                </td>
                                                <td >
                                                    <div class="commentName" style="font-size:20px;font-weight:600;margin-top:40px;"  >
                                                    </div> 
                                                    <div><input class="writeComment" type="type" style="border:none; border-bottom:1px solid gray; width:400px;" placeholder="Write a comment..."></div>
                                                    <button type="button" class="btnComment " data-toggle= "modal" data-target="#exampleModal" style="opacity: 0.4;pointer-events: none;">Send</button>
                                                    <div class="spinner-border" role="status" style="margin-left:50px; display:none;">
                                                    <span class="sr-only">Loading...</span>
                                                    </div>
                                                </td>

                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="custom-pagination">
                                <span style="display: none;" id="quantityy">{{quantityPageComment}}</span>
                                <ul class="pagination" style="margin-top:15px; margin-left:100px;">
                                <li class="page-item"><a class="page-link" href="?page=2"></a></li>
                                </ul>
                    </div>
                            </div>
                            <div class="tab-pane" id="tabs-2" role="tabpanel">
                                <div class="product__details__tab__desc">
                                    <h6>Products Infomation</h6>
                                    <p>
                                        <img src="/img/exchange.png" alt="">
                                        Free exchange within 3 days
                                    </p>
                                    <p>
                                        <img src="/img/geguine.png" alt="">
                                        Genuine product
                                    </p>
                                    <P>
                                        <img src="/img/freeship.png" alt="">
                                        Freeship for orders over $99
                                    </P>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="display: none;" id="currentPage-hb">{{curPage}}</div>
        <!-- Button trigger modal -->
{{!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
  Launch demo modal
</button> --}}

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="heading" style="text-align: center; margin-top:5px;">
        <h4>YOU ARE NOT LOG IN</h4>
      </div>
      <div class="modal-body">
        <input class="noneUsername" type="type" style="border:none;border-bottom:0.5px solid gray; width:400px; " placeholder="Please enter your name to continue...">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary " data-dismiss="modal">Save changes</button>
      </div>
    </div>
  </div>
</div>
</section>
    <!-- Product Details Section End -->

    <!-- Related Product Section Begin -->
<section class="related-product">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-title related__product__title">
                        <h2>Related Product</h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="product__discount__slider owl-carousel">
                    {{#each relateProduct}}
                    <div class="col-lg-4">
                        <div class="product__discount__item">
                            <div class="product__discount__item__pic set-bg"
                                data-setbg="https://the-1-beauty-fashion-admin.herokuapp.com{{this.imagesUrl.[0]}}">
                                <div class="product__discount__percent">-{{discount this.pricePromotion this.price}}%</div>
                                <ul class="product__item__pic__hover">
                                    <li><a href="/product/detail/{{this.slug}}"><i class="fa fa-retweet"></i></a></li>
                                    <li><a href="/product/detail/{{this.slug}}" class="shopping-cart" data-id={{_id}} data-size={{info.[0].size}} data-image="https://the-1-beauty-fashion-admin.herokuapp.com{{imagesUrl.[0]}}">
                                    <i class="fa fa-shopping-cart" data-id={{_id}} data-size={{info.[0].size}} data-image="https://the-1-beauty-fashion-admin.herokuapp.com{{imagesUrl.[0]}}"></i></a></li>
                                </ul>
                            </div>
                            <div class="product__discount__item__text">
                                <h5><a href="/product/detail/{{this.slug}}">{{this.name}}</a></h5>
                                <div class="product__item__price">${{this.pricePromotion}} <span>${{this.price}}</span></div>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        <div style="display: none;" id="JSONproduct">{{productJson}}</div>
        
</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    document.addEventListener('DOMContentLoaded',()=>{
        let product=JSON.parse(document.querySelector('#JSONproduct').innerText)
        const sizeEl=document.querySelector('.info-product-size')
        const sizeHeaderEl=document.querySelector('.info-product-size-header')
        const writeComment=document.querySelector('.writeComment')
        const avatarImg=document.querySelector('.commentAvatar')
        const commentName=document.querySelector('.commentName')
        const btnComment=document.querySelector('.btnComment')
        const productId=document.querySelector('.productId').innerText
        const tbodyEl=document.querySelector('.addCommentEl')
        const loading=document.querySelector('.spinner-border')
        const noneUsername=document.querySelector('.noneUsername')
        const btnPrimary=document.querySelector('.btn-primary')
        let checkUser=0

        function resetForm(){
            writeComment.value=''
            btnComment.style.opacity=0.6
            btnComment.style.pointerEvents='none'
        }
        if(user!=='false')
        {
            avatarImg.src=avatarUrl
            commentName.innerHTML=username
        }
        else{
            console.log('good')
            avatarImg.src="/img/none-user.jpg"
            commentName.innerHTML=''
        }

        btnPrimary.addEventListener('click',(e)=>{
            if(noneUsername.value!=="")
            {
                commentName.innerText=noneUsername.value
                checkUser=1
                btnComment.removeAttribute("data-toggle")
            }
            else{
                checkUser=0
            }

        })

        writeComment.addEventListener('input',(e)=>{
            if(e.target.value===''){
                btnComment.style.opacity=0.6
                btnComment.style.pointerEvents='none'
            }
            else{
                btnComment.style.opacity=1
                btnComment.style.pointerEvents='auto'
            }
        })

        btnComment.addEventListener('click',(e)=>{
            if(user!=='false')
            {
                btnComment.removeAttribute("data-toggle")
                loading.style.display="block"
                btnComment.style.opacity=0.6
                btnComment.style.pointerEvents='none'
                fetch(`${window.location.origin}/product/add/comment`,{
                    headers:{
                        'Accept':'application/json',
                        'Content-Type':'application/json'
                    },
                    method:'POST',
                    body:JSON.stringify({ user:user,  product:productId,content:writeComment.value})
                })
                .then(res=>res.json())
                .then(res=>{
                    btnComment.style.opacity=1
                    btnComment.style.pointerEvents='auto'
                    if(res.success) {
                        loading.style.display="none"
                        var html=` <tr>
                                    <td style="padding:20px;">
                                        <img class="avatar-img" src="${avatarUrl}" alt="" style="width:50px; height:auto;">
                                    </td>
                                    <td>
                                        <div style="display:inline-block; margin-top:10px;"> 
                                        <div style="font-size:20px;font-weight:600;float:left">${username}</div>
                                        <div style="float:right; margin-top:3px; padding-left:7px; color:rgb(126, 122, 122);">${moment(new Date()).calendar()} </div>
                                        </div>
                                        <div style="font-size: 17px; color:#000; margin-left:0px;">${writeComment.value}</div>
                                    </td>
                                    </tr>`

                        tbodyEl.innerHTML =tbodyEl.innerHTML + html
                        resetForm()
                        document.querySelector('.no-comments')?.remove()
                    }
                    else{
                        result.innerHTML='ko thanh cong!'
                    }
                })

            }
            else{
                if(checkUser==1){
                    loading.style.display="block"
                    btnComment.style.opacity=0.6
                    btnComment.style.pointerEvents='none'
                    fetch(`${window.location.origin}/product/add/comment`,{
                        headers:{
                            'Accept':'application/json',
                            'Content-Type':'application/json'
                        },
                        method:'POST',
                        body:JSON.stringify({ username: noneUsername.value,  product:productId,content:writeComment.value})
                    })
                    .then(res=>res.json())
                    .then(res=>{
                        btnComment.style.opacity=1
                        btnComment.style.pointerEvents='auto'
                        if(res.success) {
                            loading.style.display="none"
                            var html=` <tr>
                                        <td style="padding:20px;">
                                            <img class="avatar-img" src="/img/none-user.jpg" alt="" style="width:50px; height:auto;">
                                        </td>
                                        <td>
                                            <div style="display:inline-block; margin-top:10px;"> 
                                            <div style="font-size:20px;font-weight:600;float:right">${noneUsername.value}</div>
                                            <div style="float:right; margin-top:3px; padding-left:7px; color:rgb(126, 122, 122);">${moment(new Date()).calendar()} </div>
                                            </div>
                                            <div style="font-size: 17px; color:#000; margin-left:0px;">${writeComment.value}</div>
                                        </td>
                                        </tr>`

                            tbodyEl.innerHTML =tbodyEl.innerHTML + html
                            resetForm()
                            document.querySelector('.no-comments')?.remove()
                        }
                        else{
                            result.innerHTML='ko thanh cong!'
                        }
                    })
                }
                else{
                    console.log('chua dang nhap')
                }
            }
        })

        let htmlSize=product.info.map((item,index)=>{
            return`
                <div class="info-product-size-item ${index===0?'active':''}" data-size="${item.size}" data-quantity="${item.quantity}">
                    ${item.size}
                </div>
            `
        }).join('')
        sizeEl.innerHTML=htmlSize
        const sizeItemEl=document.querySelectorAll('.info-product-size-item')
        function removeActive(){
            sizeItemEl.forEach(item=>{
                item.classList.remove('active')
            })
        }
        sizeItemEl.forEach(item=>{
            item.addEventListener('click',(e)=>{
                removeActive()
                item.classList.add('active')
                sizeHeaderEl.innerText=`Size ${e.target.dataset.size} : ${e.target.dataset.quantity} sản phẩm sẵn có`
            })
        })


        
        const btnAddCartt=document.querySelector('.btn-add-cart')
        const quantity=document.querySelector('input[name="quantity-product"]')

        btnAddCartt.addEventListener('click',(e)=>{
            let activeSize=document.querySelector('.info-product-size-item.active')
            if(user!=='false'){
                fetch(`${window.location.origin}/cart/add`,{
                    headers:{
                        'Accept':'application/json',
                        'Content-Type':'application/json'
                    },
                    method:'POST',
                    body:JSON.stringify({id:e.target.dataset.id,user:user,quantity:parseInt(quantity.value),size:activeSize.dataset.size})
                })
                .then(res=>res.json())
                .then(res=>{
                    console.log(res)
                    if(res.success){
                        getToast(e)
                        fetchCart2()
                    }
                })
            }
            else{
                console.log(JSON.parse(localStorage.getItem('cart')))
                const cart2=JSON.parse(localStorage.getItem('cart'))
                console.log(cart2)
                let newCartItem={
                    product:e.target.dataset.id,
                    infor:{
                        size:activeSize.dataset.size,
                        quantity:parseInt(quantity.value)
                    }
                }
                if(!cart2){
                    console.log(' udsfds fsdfklds fsd')
                    let newCart=[newCartItem]
                    let cartt={
                        cart:newCart
                    }
                    localStorage.setItem('cart',JSON.stringify(cartt))
                    document.querySelector('.cart-length').innerHTML=1
                }
                else{
                    let check=false;
                    for(let i=0;i<cart2.cart.length;i++){
                        if(cart2.cart[i].product===e.target.dataset.id)
                        {
                            if(cart2.cart[i].infor.size===activeSize.dataset.size){
                                cart2.cart[i].infor.quantity+=parseInt(quantity.value)
                                check=true;
                                break;
                            }
                            
                        } 
                    }
                    if(!check){
                        cart2.cart.push(newCartItem)
                    }
                    localStorage.setItem('cart',JSON.stringify(cart2))
                    document.querySelector('.cart-length').innerHTML=cart2.cart.length
                }
                getToast(e)
            }
        })
        const paginaEl=document.querySelector('.pagination')
        const currentPage=parseInt(document.querySelector('#currentPage-hb').innerText)
        const quantityy=parseInt(document.querySelector('#quantityy').innerText)
        let htmlPagi=`<li class="page-item"><a class="page-link" href="?page=${currentPage===1?1:currentPage-1}"> <i class="bi bi-caret-left-fill"></i> </a></li>`
        for(let i=1;i<=quantityy;i++){
            htmlPagi+=`<li class="page-item"><a class="page-link ${i==currentPage?'active-page-item':''}" href="?page=${i}">${i}</a></li>`
        }
        htmlPagi+=`<li class="page-item"><a class="page-link" href="?page=${currentPage===quantityy?quantityy:currentPage+1}"> <i class="bi bi-caret-right-fill"></i> </a></li>`
        paginaEl.innerHTML=htmlPagi

    })
</script>